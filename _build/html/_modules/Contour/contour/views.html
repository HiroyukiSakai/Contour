<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Contour.contour.views &mdash; Contour 1.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Contour 1.0.1 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Contour 1.0.1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for Contour.contour.views</h1><div class="highlight"><pre>
<span class="c">#   Contour  Copyright (C) 2013-2014  Hiroyuki Sakai</span>
<span class="c">#</span>
<span class="c">#   This file is part of Contour.</span>
<span class="c">#</span>
<span class="c">#   Contour is free software: you can redistribute it and/or modify</span>
<span class="c">#   it under the terms of the GNU General Public License as published by</span>
<span class="c">#   the Free Software Foundation, either version 3 of the License, or</span>
<span class="c">#   (at your option) any later version.</span>
<span class="c">#</span>
<span class="c">#   Contour is distributed in the hope that it will be useful,</span>
<span class="c">#   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c">#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c">#   GNU General Public License for more details.</span>
<span class="c">#</span>
<span class="c">#   You should have received a copy of the GNU General Public License</span>
<span class="c">#   along with Contour.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;Describes the views used in Contour.</span>

<span class="sd">.. moduleauthor:: Hiroyuki Sakai &lt;hiroyuki.sakai@student.tuwien.ac.at&gt;</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">base64</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">pdb</span><span class="o">,</span> <span class="nn">urllib</span>

<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span> <span class="k">as</span> <span class="n">PImage</span>

<span class="kn">from</span> <span class="nn">django.core.files</span> <span class="kn">import</span> <span class="n">File</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">Http404</span><span class="p">,</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span>

<span class="kn">import</span> <span class="nn">flickrapi</span><span class="o">,</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">misc</span><span class="p">,</span> <span class="n">ndimage</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">io</span><span class="p">,</span> <span class="n">transform</span>

<span class="kn">import</span> <span class="nn">secret</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.set_metrics</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">slugify</span>


<span class="n">MISSING_PIXELS_PENALTY_FACTOR</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">SUPERFLUOUS_PIXELS_PENALTY_FACTOR</span> <span class="o">=</span> <span class="o">.</span><span class="mi">1</span>


<div class="viewcode-block" id="create_session"><a class="viewcode-back" href="../../../Contour.contour.html#Contour.contour.views.create_session">[docs]</a><span class="k">def</span> <span class="nf">create_session</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">view_name</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a user session.</span>

<span class="sd">    :param request: The request object containing the user request.</span>
<span class="sd">    :type request: :class:`django.http.HttpRequest`.</span>
<span class="sd">    :param view_name: The name of the view to which the session should be associated.</span>
<span class="sd">    :type view_name: string.</span>
<span class="sd">    :param id: The id of the :class:`.models.Image` or :class:`.models.Track`.</span>
<span class="sd">    :type id: int.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;is_playing&#39;</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;is_playing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;view_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">view_name</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
</div>
<div class="viewcode-block" id="clear_session"><a class="viewcode-back" href="../../../Contour.contour.html#Contour.contour.views.clear_session">[docs]</a><span class="k">def</span> <span class="nf">clear_session</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clears all varibles of the user session.</span>

<span class="sd">    :param request: The request object containing the user session.</span>
<span class="sd">    :type request: :class:`django.http.HttpRequest`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;is_playing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;view_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;image_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;image_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;track_session_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;drawing_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;last_drawing_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="destroy_session"><a class="viewcode-back" href="../../../Contour.contour.html#Contour.contour.views.destroy_session">[docs]</a><span class="k">def</span> <span class="nf">destroy_session</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Destroys a currently running user session if such a request has been sent.</span>

<span class="sd">    :param request: The request object containing the user request.</span>
<span class="sd">    :type request: :class:`django.http.HttpRequest`.</span>
<span class="sd">    :returns: bool -- `True` if the session was cleared, otherwise `None`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;is_playing&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">DiscardSessionForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;discard_session&#39;</span><span class="p">]:</span>
            <span class="n">clear_session</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">return</span>
</div>
<div class="viewcode-block" id="check_session"><a class="viewcode-back" href="../../../Contour.contour.html#Contour.contour.views.check_session">[docs]</a><span class="k">def</span> <span class="nf">check_session</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">view_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Checks if the requested URL is in canon with the currently running session. The user will be asked if he wants to discad his session if there&#39;s a discrepancy.</span>

<span class="sd">    :param request: The request object containing the user request.</span>
<span class="sd">    :type request: :class:`django.http.HttpRequest`.</span>
<span class="sd">    :param view_name: The name of the requested view to which the session should be associated.</span>
<span class="sd">    :type view_name: string.</span>
<span class="sd">    :param id: The id of the requested :class:`.models.Image` or :class:`.models.Track`.</span>
<span class="sd">    :type id: int.</span>
<span class="sd">    :returns: :class:`django.http.HttpResponse` -- The rendered template as response.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;is_playing&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">view_name</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;view_name&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">id</span> <span class="o">!=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;confirm_discard.html&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s">&#39;form&#39;</span><span class="p">:</span> <span class="n">DiscardSessionForm</span><span class="p">(),</span>
            <span class="s">&#39;view_name&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;view_name&#39;</span><span class="p">),</span>
            <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">),</span>
        <span class="p">});</span>
</div>
<div class="viewcode-block" id="get_player"><a class="viewcode-back" href="../../../Contour.contour.html#Contour.contour.views.get_player">[docs]</a><span class="k">def</span> <span class="nf">get_player</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a :class:`.models.Player` object. A new player will be created if the requested player doesn&#39;t exist.</span>

<span class="sd">    :param view_name: The name of the requested player.</span>
<span class="sd">    :type view_name: string.</span>
<span class="sd">    :returns: :class:`models.Player` -- The requested player.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">player</span> <span class="o">=</span> <span class="n">Player</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Player</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="n">player</span> <span class="o">=</span> <span class="n">Player</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="n">player</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">player</span>
</div>
<div class="viewcode-block" id="save_session"><a class="viewcode-back" href="../../../Contour.contour.html#Contour.contour.views.save_session">[docs]</a><span class="k">def</span> <span class="nf">save_session</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Saves a track session. This function is called as soon as the player chooses to save his scores.</span>

<span class="sd">    :param request: The request object containing the user request.</span>
<span class="sd">    :type request: :class:`django.http.HttpRequest`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;is_playing&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">SaveSessionForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;save_session&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;drawing_id&#39;</span><span class="p">):</span>
                <span class="n">drawing</span> <span class="o">=</span> <span class="n">Drawing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;drawing_id&#39;</span><span class="p">))</span>
                <span class="n">player</span> <span class="o">=</span> <span class="n">get_player</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span>

                <span class="n">drawing</span><span class="o">.</span><span class="n">player</span> <span class="o">=</span> <span class="n">player</span>
                <span class="n">drawing</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;track_session_id&#39;</span><span class="p">):</span>
                <span class="n">track_session</span> <span class="o">=</span> <span class="n">TrackSession</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;track_session_id&#39;</span><span class="p">))</span>
                <span class="n">player</span> <span class="o">=</span> <span class="n">get_player</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span>

                <span class="n">track_session</span><span class="o">.</span><span class="n">player</span> <span class="o">=</span> <span class="n">player</span>
                <span class="n">track_session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">drawing</span> <span class="ow">in</span> <span class="n">Drawing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">track_session</span><span class="o">=</span><span class="n">track_session</span><span class="p">):</span>
                    <span class="n">drawing</span><span class="o">.</span><span class="n">player</span> <span class="o">=</span> <span class="n">player</span>
                    <span class="n">drawing</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">clear_session</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="process_image"><a class="viewcode-back" href="../../../Contour.contour.html#Contour.contour.views.process_image">[docs]</a><span class="k">def</span> <span class="nf">process_image</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates an edge image and calculates the values needed for the score calculation if necessary. This function is called as soon as an image is requested.</span>

<span class="sd">    :param request: The request object containing the user request.</span>
<span class="sd">    :type request: :class:`django.http.HttpRequest`.</span>
<span class="sd">    :param image: The image to be processed.</span>
<span class="sd">    :type image: :class:`models.Image`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># detect edges</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">image</span><span class="o">.</span><span class="n">edge_image</span><span class="p">:</span>
        <span class="n">greyscale_image</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_ROOT</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">as_grey</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># resize image</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">greyscale_image</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">greyscale_image</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">768.0</span> <span class="o">/</span> <span class="n">height</span>
        <span class="n">greyscale_image</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">greyscale_image</span><span class="p">,</span> <span class="p">[</span><span class="n">height</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="n">factor</span><span class="p">])</span>

        <span class="c"># detect edges</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="nb">filter</span><span class="o">.</span><span class="n">canny</span><span class="p">(</span><span class="n">greyscale_image</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">canny_sigma</span><span class="p">,</span> <span class="n">low_threshold</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">canny_low_threshold</span><span class="p">,</span> <span class="n">high_threshold</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">canny_high_threshold</span><span class="p">)</span>

        <span class="c"># save edge image</span>
        <span class="n">temp_filename</span> <span class="o">=</span> <span class="s">&#39;/tmp/&#39;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">session_key</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span>
        <span class="n">io</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">,</span> <span class="o">~</span><span class="n">edges</span> <span class="o">*</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="n">image</span><span class="o">.</span><span class="n">edge_image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">slugify</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">)))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">image</span><span class="o">.</span><span class="n">dilated_edge_image</span><span class="p">:</span>
        <span class="n">edge_image</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_ROOT</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">edge_image</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">as_grey</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">edge_image</span> <span class="o">=</span> <span class="n">edge_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">edge_image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="n">edge_image</span> <span class="o">/=</span> <span class="mf">255.</span>

        <span class="c"># map values greater .5 as edge</span>
        <span class="n">edge_image</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">edge_image</span><span class="p">)</span> <span class="o">/</span> <span class="o">.</span><span class="mi">5</span>

        <span class="c"># save dilated edge image</span>
        <span class="n">temp_filename</span> <span class="o">=</span> <span class="s">&#39;/tmp/&#39;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">session_key</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span>
        <span class="n">io</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">,</span> <span class="o">~</span><span class="n">ndimage</span><span class="o">.</span><span class="n">binary_dilation</span><span class="p">(</span><span class="n">edge_image</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="n">image</span><span class="o">.</span><span class="n">dilated_edge_image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">slugify</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">)))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">)</span>

    <span class="c"># save maximum distance (needed for score calculation)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">image</span><span class="o">.</span><span class="n">max_distance</span><span class="p">:</span>
        <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">edge_image</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">edge_image</span><span class="o">.</span><span class="n">width</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">image</span><span class="o">.</span><span class="n">edge_image</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">edge_image</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>

        <span class="n">dilated_edge_image</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_ROOT</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dilated_edge_image</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">as_grey</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">dilated_edge_image</span> <span class="o">=</span> <span class="n">dilated_edge_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dilated_edge_image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
            <span class="n">dilated_edge_image</span> <span class="o">/=</span> <span class="mf">255.</span>

        <span class="n">image</span><span class="o">.</span><span class="n">max_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">ones</span> <span class="o">-</span> <span class="n">dilated_edge_image</span><span class="p">))</span>
        <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="handle_finished_drawing"><a class="viewcode-back" href="../../../Contour.contour.html#Contour.contour.views.handle_finished_drawing">[docs]</a><span class="k">def</span> <span class="nf">handle_finished_drawing</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is called as soon as the user finishes his drawing. It saves and associates his drawing to the running track session. It also assesses the score of the drawing.</span>

<span class="sd">    :param request: The request object containing the user request.</span>
<span class="sd">    :type request: :class:`django.http.HttpRequest`.</span>
<span class="sd">    :returns: :class:`models.Drawing` -- The created drawing object.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;is_playing&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">FinishDrawingForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;finish_drawing&#39;</span><span class="p">]:</span>
                <span class="c"># save drawing</span>
                <span class="n">image_data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;image&#39;</span><span class="p">])</span>
                <span class="n">temp_filename</span> <span class="o">=</span> <span class="s">&#39;/tmp/&#39;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">session_key</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span>
                <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="n">im</span> <span class="o">=</span> <span class="n">PImage</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">)</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s">&quot;RGB&quot;</span><span class="p">)</span>
                <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">,</span> <span class="s">&quot;PNG&quot;</span><span class="p">)</span>

                <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;image_id&#39;</span><span class="p">))</span>

                <span class="c"># calculate distance</span>
                <span class="n">greyscale_drawing</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">,</span> <span class="n">as_grey</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">greyscale_drawing</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">imresize</span><span class="p">(</span><span class="n">greyscale_drawing</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">edge_image</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">edge_image</span><span class="o">.</span><span class="n">width</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span>
                <span class="n">dilated_edge_image</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_ROOT</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">dilated_edge_image</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">as_grey</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

                <span class="n">greyscale_drawing</span> <span class="o">=</span> <span class="n">greyscale_drawing</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">dilated_edge_image</span> <span class="o">=</span> <span class="n">dilated_edge_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

                <span class="c"># correct ranges of images if necessary</span>
                <span class="k">if</span> <span class="n">greyscale_drawing</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
                    <span class="n">greyscale_drawing</span> <span class="o">/=</span> <span class="mf">255.</span>
                <span class="k">if</span> <span class="n">dilated_edge_image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
                    <span class="n">dilated_edge_image</span> <span class="o">/=</span> <span class="mf">255.</span>

                <span class="n">missing_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">greyscale_drawing</span> <span class="o">-</span> <span class="n">dilated_edge_image</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
                <span class="n">overlapping_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">greyscale_drawing</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">dilated_edge_image</span><span class="p">),</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
                <span class="n">superfluous_pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">dilated_edge_image</span> <span class="o">-</span> <span class="n">greyscale_drawing</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>

                <span class="c"># number of pixels in the edge image which are not covered</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">missing_pixels</span><span class="p">)</span> <span class="o">*</span> <span class="n">MISSING_PIXELS_PENALTY_FACTOR</span><span class="p">;</span>
                <span class="c"># number of pixels in the drawing which are misplaced</span>
                <span class="n">distance</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">superfluous_pixels</span><span class="p">)</span> <span class="o">*</span> <span class="n">SUPERFLUOUS_PIXELS_PENALTY_FACTOR</span><span class="p">;</span>
                <span class="n">score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">image</span><span class="o">.</span><span class="n">max_distance</span> <span class="o">-</span> <span class="n">distance</span><span class="p">)</span> <span class="o">/</span> <span class="n">image</span><span class="o">.</span><span class="n">max_distance</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

                <span class="c"># save drawing</span>
                <span class="n">drawing</span> <span class="o">=</span> <span class="n">Drawing</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">)</span>
                <span class="n">drawing</span><span class="o">.</span><span class="n">drawing</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">session_key</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">)))</span>

                <span class="c"># generate and save score image</span>
                <span class="n">score_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">image</span><span class="o">.</span><span class="n">edge_image</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">edge_image</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">score_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">missing_pixels</span>
                <span class="n">score_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">missing_pixels</span>
                <span class="n">score_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">missing_pixels</span>
                <span class="n">score_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">superfluous_pixels</span>
                <span class="n">score_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">overlapping_pixels</span>
                <span class="n">io</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">,</span> <span class="n">score_image</span> <span class="o">*</span> <span class="mf">1.</span><span class="p">)</span>
                <span class="n">drawing</span><span class="o">.</span><span class="n">score_image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">session_key</span> <span class="o">+</span> <span class="s">&#39;_score.png&#39;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">)))</span>

                <span class="n">drawing</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="c"># delete temporary file</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">drawing</span>
    <span class="k">return</span>
</div>
<div class="viewcode-block" id="handle_finished_edge_image"><a class="viewcode-back" href="../../../Contour.contour.html#Contour.contour.views.handle_finished_edge_image">[docs]</a><span class="k">def</span> <span class="nf">handle_finished_edge_image</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is called as soon as the admin finishes his drawing.</span>

<span class="sd">    :param request: The request object containing the user request.</span>
<span class="sd">    :type request: :class:`django.http.HttpRequest`.</span>
<span class="sd">    :returns: :class:`models.Drawing` -- The created drawing object.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">FinishEdgeImageForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;finish_edge_image&#39;</span><span class="p">]:</span>
            <span class="c"># save new edge image</span>
            <span class="n">image_data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;image&#39;</span><span class="p">])</span>
            <span class="n">temp_filename</span> <span class="o">=</span> <span class="s">&#39;/tmp/&#39;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">session_key</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;image_id&#39;</span><span class="p">])</span>

            <span class="n">im</span> <span class="o">=</span> <span class="n">PImage</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s">&quot;RGB&quot;</span><span class="p">)</span>
            <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">,</span> <span class="s">&quot;PNG&quot;</span><span class="p">)</span>

            <span class="n">edge_image</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">,</span> <span class="n">as_grey</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">edge_image</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">imresize</span><span class="p">(</span><span class="n">edge_image</span><span class="p">,</span> <span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">edge_image</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">edge_image</span><span class="o">.</span><span class="n">width</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;F&#39;</span><span class="p">)</span>
            <span class="n">edge_image</span> <span class="o">=</span> <span class="n">edge_image</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

            <span class="c"># correct ranges of images if necessary</span>
            <span class="k">if</span> <span class="n">edge_image</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">1.</span><span class="p">:</span>
                <span class="n">edge_image</span> <span class="o">/=</span> <span class="mf">255.</span>

            <span class="c"># save edge image</span>
            <span class="n">image</span><span class="o">.</span><span class="n">edge_image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">edge_image</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">)))</span>

            <span class="c"># delete old computed values</span>
            <span class="n">image</span><span class="o">.</span><span class="n">max_distance</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">image</span><span class="o">.</span><span class="n">dilated_edge_image</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="c"># delete temporary file</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">image</span><span class="o">.</span><span class="n">edge_image</span>
    <span class="k">return</span>
</div>
<div class="viewcode-block" id="handle_uploaded_file"><a class="viewcode-back" href="../../../Contour.contour.html#Contour.contour.views.handle_uploaded_file">[docs]</a><span class="k">def</span> <span class="nf">handle_uploaded_file</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is called as soon as the user uploads a file. It saves his image on the filesystem.</span>

<span class="sd">    :param request: The request object containing the user request.</span>
<span class="sd">    :type request: :class:`django.http.HttpRequest`.</span>
<span class="sd">    :returns: :class:`models.Image` -- The created image object.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s">&#39;file&#39;</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;sigma&#39;</span><span class="p">]</span>

    <span class="c"># save file</span>
    <span class="n">temp_filename</span> <span class="o">=</span> <span class="s">&#39;/tmp/&#39;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">session_key</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">,</span> <span class="s">&#39;wb+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">destination</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">file</span><span class="o">.</span><span class="n">chunks</span><span class="p">():</span>
            <span class="n">destination</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>

    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">slugify</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">canny_sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
    <span class="n">split</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
    <span class="n">image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">slugify</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">File</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">)))</span>
    <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">image</span>
</div>
<div class="viewcode-block" id="handle_flickr_search"><a class="viewcode-back" href="../../../Contour.contour.html#Contour.contour.views.handle_flickr_search">[docs]</a><span class="k">def</span> <span class="nf">handle_flickr_search</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is called as soon as the user submits a Flickr search query. It saves the found image on the filesystem.</span>

<span class="sd">    :param request: The request object containing the user request.</span>
<span class="sd">    :type request: :class:`django.http.HttpRequest`.</span>
<span class="sd">    :returns: :class:`models.Image` -- The created image object.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;query&#39;</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;sigma&#39;</span><span class="p">]</span>

    <span class="n">flickr</span> <span class="o">=</span> <span class="n">flickrapi</span><span class="o">.</span><span class="n">FlickrAPI</span><span class="p">(</span><span class="n">secret</span><span class="o">.</span><span class="n">FLICKR_API_KEY</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">photo</span> <span class="ow">in</span> <span class="n">flickr</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">extras</span><span class="o">=</span><span class="s">&#39;1&#39;</span><span class="p">):</span>

        <span class="n">temp_filename</span> <span class="o">=</span> <span class="s">&#39;/tmp/&#39;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">session_key</span> <span class="o">+</span> <span class="s">&#39;.jpg&#39;</span>
        <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="s">&#39;http://farm&#39;</span> <span class="o">+</span> <span class="n">photo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;farm&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.staticflickr.com/&#39;</span> <span class="o">+</span> <span class="n">photo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;server&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">photo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;_&#39;</span> <span class="o">+</span> <span class="n">photo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;secret&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.jpg&#39;</span><span class="p">,</span> <span class="n">temp_filename</span><span class="p">)</span>

        <span class="n">title</span> <span class="o">=</span> <span class="n">slugify</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">photo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">)))</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="s">&#39;http://www.flickr.com/photos/&#39;</span> <span class="o">+</span> <span class="n">photo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;owner&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">photo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">),</span> <span class="n">canny_sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
        <span class="n">image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">title</span><span class="p">[:</span><span class="mi">64</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;.jpg&#39;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">)))</span>
        <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_filename</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">image</span>

</div>
<div class="viewcode-block" id="index"><a class="viewcode-back" href="../../../Contour.contour.html#Contour.contour.views.index">[docs]</a><span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is the view function for the home page.</span>

<span class="sd">    :param request: The request object containing the user request.</span>
<span class="sd">    :type request: :class:`django.http.HttpRequest`.</span>
<span class="sd">    :returns: :class:`django.http.HttpResponse` -- The rendered template as response.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clear_canvas</span> <span class="o">=</span> <span class="n">destroy_session</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">save_session</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="n">discard_session_page</span> <span class="o">=</span> <span class="n">check_session</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">discard_session_page</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">discard_session_page</span>


    <span class="n">tracks</span> <span class="o">=</span> <span class="n">Track</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="n">track_highscores</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">:</span>
        <span class="n">track_highscores</span><span class="p">[</span><span class="n">track</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="n">track</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="s">&#39;highscores&#39;</span><span class="p">:</span> <span class="n">TrackSession</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">player__isnull</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">track</span><span class="o">=</span><span class="n">track</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-score&#39;</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;main_menu.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">&#39;upload_file_form&#39;</span><span class="p">:</span> <span class="n">UploadFileForm</span><span class="p">(),</span>
        <span class="s">&#39;search_flickr_form&#39;</span><span class="p">:</span> <span class="n">SearchFlickrForm</span><span class="p">(),</span>
        <span class="s">&#39;tracks&#39;</span><span class="p">:</span> <span class="n">tracks</span><span class="p">,</span>
        <span class="s">&#39;track_highscores&#39;</span><span class="p">:</span> <span class="n">track_highscores</span><span class="p">,</span>
        <span class="s">&#39;single_drawing_highscores&#39;</span><span class="p">:</span> <span class="n">Drawing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">player__isnull</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">track_session__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="s">&#39;clear_canvas&#39;</span><span class="p">:</span> <span class="n">clear_canvas</span><span class="p">,</span>
    <span class="p">})</span>
</div>
<div class="viewcode-block" id="canvas"><a class="viewcode-back" href="../../../Contour.contour.html#Contour.contour.views.canvas">[docs]</a><span class="k">def</span> <span class="nf">canvas</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is the view function for a single drawing canvas. It is called for the file upload and Flickr game modes.</span>

<span class="sd">    :param request: The request object containing the user request.</span>
<span class="sd">    :type request: :class:`django.http.HttpRequest`.</span>
<span class="sd">    :param id: The id of the requested :class:`.models.Image`.</span>
<span class="sd">    :type id: int.</span>
<span class="sd">    :returns: :class:`django.http.HttpResponse` -- The rendered template as response.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">view_name</span> <span class="o">=</span> <span class="s">&#39;Contour.contour.views.canvas&#39;</span>
    <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="nb">long</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">view_name</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;view_name&#39;</span><span class="p">):</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>


    <span class="n">image</span> <span class="o">=</span> <span class="bp">None</span><span class="p">;</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">UploadFileForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">handle_uploaded_file</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">image</span><span class="p">:</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">id</span>

        <span class="n">form</span> <span class="o">=</span> <span class="n">SearchFlickrForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">handle_flickr_search</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">image</span><span class="p">:</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">id</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">image</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Image</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span>


    <span class="n">clear_canvas</span> <span class="o">=</span> <span class="n">destroy_session</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="n">discard_session_page</span> <span class="o">=</span> <span class="n">check_session</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">view_name</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">discard_session_page</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">discard_session_page</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;is_playing&#39;</span><span class="p">):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;image_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;image_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">create_session</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">view_name</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>


    <span class="n">drawing</span> <span class="o">=</span> <span class="n">handle_finished_drawing</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">drawing</span><span class="p">:</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;last_drawing_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">drawing</span><span class="o">.</span><span class="n">id</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;dont_show_welcome&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;drawing_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">drawing</span><span class="o">.</span><span class="n">id</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;image_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;image_index&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>


    <span class="n">last_drawing</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;last_drawing_id&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">last_drawing</span> <span class="o">=</span> <span class="n">Drawing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;last_drawing_id&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">Drawing</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="bp">None</span>


    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">RetryDrawingForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;retry_drawing&#39;</span><span class="p">]:</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;last_drawing_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;image_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;image_index&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="n">last_drawing</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="n">last_drawing</span> <span class="o">=</span> <span class="bp">None</span>


    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;image_index&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;completed.html&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s">&#39;retry_drawing_form&#39;</span><span class="p">:</span> <span class="n">RetryDrawingForm</span><span class="p">(),</span>
            <span class="s">&#39;save_session_form&#39;</span><span class="p">:</span> <span class="n">SaveSessionForm</span><span class="p">(),</span>
            <span class="s">&#39;discard_session_form&#39;</span><span class="p">:</span> <span class="n">DiscardSessionForm</span><span class="p">(),</span>
            <span class="s">&#39;drawing&#39;</span><span class="p">:</span> <span class="n">Drawing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;drawing_id&#39;</span><span class="p">)),</span>
            <span class="s">&#39;last_drawing&#39;</span><span class="p">:</span> <span class="n">last_drawing</span><span class="p">,</span>
        <span class="p">})</span>

    <span class="n">process_image</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;game.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">&#39;finish_drawing_form&#39;</span><span class="p">:</span> <span class="n">FinishDrawingForm</span><span class="p">(),</span>
        <span class="s">&#39;retry_drawing_form&#39;</span><span class="p">:</span> <span class="n">RetryDrawingForm</span><span class="p">(),</span>
        <span class="s">&#39;image&#39;</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span>
        <span class="s">&#39;score&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s">&#39;clear_canvas&#39;</span><span class="p">:</span> <span class="n">clear_canvas</span><span class="p">,</span>
        <span class="s">&#39;show_welcome&#39;</span><span class="p">:</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;dont_show_welcome&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span>
        <span class="s">&#39;last_drawing&#39;</span><span class="p">:</span> <span class="n">last_drawing</span><span class="p">,</span>
    <span class="p">})</span>
</div>
<div class="viewcode-block" id="track"><a class="viewcode-back" href="../../../Contour.contour.html#Contour.contour.views.track">[docs]</a><span class="k">def</span> <span class="nf">track</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is the view function for track sessions.</span>

<span class="sd">    :param request: The request object containing the user request.</span>
<span class="sd">    :type request: :class:`django.http.HttpRequest`.</span>
<span class="sd">    :param id: The id of the requested :class:`.models.Track`.</span>
<span class="sd">    :type id: int.</span>
<span class="sd">    :returns: :class:`django.http.HttpResponse` -- The rendered template as response.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">view_name</span> <span class="o">=</span> <span class="s">&#39;Contour.contour.views.track&#39;</span>
    <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="nb">long</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">track</span> <span class="o">=</span> <span class="n">Track</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Track</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span>


    <span class="n">clear_canvas</span> <span class="o">=</span> <span class="n">destroy_session</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="n">discard_session_page</span> <span class="o">=</span> <span class="n">check_session</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">view_name</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">discard_session_page</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">discard_session_page</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;is_playing&#39;</span><span class="p">):</span>
        <span class="n">track_session</span> <span class="o">=</span> <span class="n">TrackSession</span><span class="p">(</span><span class="n">session_key</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">session_key</span><span class="p">,</span> <span class="n">track</span><span class="o">=</span><span class="n">track</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">track_session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;image_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;track_session_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">track_session</span><span class="o">.</span><span class="n">id</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">track_session</span> <span class="o">=</span> <span class="n">TrackSession</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;track_session_id&#39;</span><span class="p">))</span>

    <span class="n">create_session</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">view_name</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>


    <span class="n">drawing</span> <span class="o">=</span> <span class="n">handle_finished_drawing</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">drawing</span><span class="p">:</span>
        <span class="n">drawing</span><span class="o">.</span><span class="n">track_session</span> <span class="o">=</span> <span class="n">track_session</span>
        <span class="n">drawing</span><span class="o">.</span><span class="n">track_session_index</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;image_index&#39;</span><span class="p">)</span>
        <span class="n">drawing</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;last_drawing_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">drawing</span><span class="o">.</span><span class="n">id</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;dont_show_welcome&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;image_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;image_index&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">track_session</span><span class="o">.</span><span class="n">score</span> <span class="o">+=</span> <span class="n">drawing</span><span class="o">.</span><span class="n">score</span>
        <span class="n">track_session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>


    <span class="n">last_drawing</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;last_drawing_id&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">last_drawing</span> <span class="o">=</span> <span class="n">Drawing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;last_drawing_id&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">Drawing</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="bp">None</span>


    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">RetryDrawingForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;retry_drawing&#39;</span><span class="p">]:</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;last_drawing_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;image_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;image_index&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="n">track_session</span><span class="o">.</span><span class="n">score</span> <span class="o">-=</span> <span class="n">last_drawing</span><span class="o">.</span><span class="n">score</span>
            <span class="n">track_session</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">last_drawing</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="n">last_drawing</span> <span class="o">=</span> <span class="bp">None</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">TrackImage</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">track</span><span class="o">=</span><span class="n">track</span><span class="p">)[</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;image_index&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">image</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;completed.html&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s">&#39;retry_drawing_form&#39;</span><span class="p">:</span> <span class="n">RetryDrawingForm</span><span class="p">(),</span>
            <span class="s">&#39;save_session_form&#39;</span><span class="p">:</span> <span class="n">SaveSessionForm</span><span class="p">(),</span>
            <span class="s">&#39;discard_session_form&#39;</span><span class="p">:</span> <span class="n">DiscardSessionForm</span><span class="p">(),</span>
            <span class="s">&#39;track_session&#39;</span><span class="p">:</span> <span class="n">track_session</span><span class="p">,</span>
            <span class="s">&#39;drawings&#39;</span><span class="p">:</span> <span class="n">Drawing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">track_session</span><span class="o">=</span><span class="n">track_session</span><span class="p">),</span>
            <span class="s">&#39;last_drawing&#39;</span><span class="p">:</span> <span class="n">last_drawing</span><span class="p">,</span>
        <span class="p">})</span>

    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">&#39;image_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">id</span>
    <span class="n">process_image</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;game.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">&#39;finish_drawing_form&#39;</span><span class="p">:</span> <span class="n">FinishDrawingForm</span><span class="p">(),</span>
        <span class="s">&#39;retry_drawing_form&#39;</span><span class="p">:</span> <span class="n">RetryDrawingForm</span><span class="p">(),</span>
        <span class="s">&#39;image&#39;</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span>
        <span class="s">&#39;score&#39;</span><span class="p">:</span> <span class="n">track_session</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
        <span class="s">&#39;clear_canvas&#39;</span><span class="p">:</span> <span class="n">clear_canvas</span><span class="p">,</span>
        <span class="s">&#39;image_number&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;image_index&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s">&#39;image_count&#39;</span><span class="p">:</span> <span class="n">TrackImage</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">track</span><span class="o">=</span><span class="n">track</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="s">&#39;show_welcome&#39;</span><span class="p">:</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;dont_show_welcome&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span>
        <span class="s">&#39;last_drawing&#39;</span><span class="p">:</span> <span class="n">last_drawing</span><span class="p">,</span>
    <span class="p">})</span>
</div>
<div class="viewcode-block" id="drawing"><a class="viewcode-back" href="../../../Contour.contour.html#Contour.contour.views.drawing">[docs]</a><span class="k">def</span> <span class="nf">drawing</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is the view function to view the score summary of single drawings.</span>

<span class="sd">    :param request: The request object containing the user request.</span>
<span class="sd">    :type request: :class:`django.http.HttpRequest`.</span>
<span class="sd">    :param id: The id of the requested :class:`.models.Drawing`.</span>
<span class="sd">    :type id: int.</span>
<span class="sd">    :returns: :class:`django.http.HttpResponse` -- The rendered template as response.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="nb">long</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">drawing</span> <span class="o">=</span> <span class="n">Drawing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">player__isnull</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Drawing</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;drawing.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">&#39;drawing&#39;</span><span class="p">:</span> <span class="n">drawing</span><span class="p">,</span>
    <span class="p">})</span>
</div>
<div class="viewcode-block" id="session"><a class="viewcode-back" href="../../../Contour.contour.html#Contour.contour.views.session">[docs]</a><span class="k">def</span> <span class="nf">session</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is the view function to view the score summary of track sessions.</span>

<span class="sd">    :param request: The request object containing the user request.</span>
<span class="sd">    :type request: :class:`django.http.HttpRequest`.</span>
<span class="sd">    :param id: The id of the requested :class:`.models.TrackSession`.</span>
<span class="sd">    :type id: int.</span>
<span class="sd">    :returns: :class:`django.http.HttpResponse` -- The rendered template as response.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="nb">long</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">track_session</span> <span class="o">=</span> <span class="n">TrackSession</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span> <span class="n">player__isnull</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">TrackSession</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;session.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">&#39;track_session&#39;</span><span class="p">:</span> <span class="n">track_session</span><span class="p">,</span>
        <span class="s">&#39;drawings&#39;</span><span class="p">:</span> <span class="n">Drawing</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">track_session</span><span class="o">=</span><span class="n">track_session</span><span class="p">),</span>
    <span class="p">})</span>
</div>
<div class="viewcode-block" id="admin_edge_image"><a class="viewcode-back" href="../../../Contour.contour.html#Contour.contour.views.admin_edge_image">[docs]</a><span class="k">def</span> <span class="nf">admin_edge_image</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is the view function to edit the edge images in the admin section.</span>

<span class="sd">    :param request: The request object containing the user request.</span>
<span class="sd">    :type request: :class:`django.http.HttpRequest`.</span>
<span class="sd">    :param id: The id of the requested :class:`.models.Image`.</span>
<span class="sd">    :type id: int.</span>
<span class="sd">    :returns: :class:`django.http.HttpResponse` -- The rendered template as response.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">id</span><span class="p">:</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="nb">long</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Image</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span>

    <span class="n">process_image</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>

    <span class="n">edge_image</span> <span class="o">=</span> <span class="n">handle_finished_edge_image</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">edge_image</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;admin/edge_image.html&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="s">&#39;form&#39;</span><span class="p">:</span> <span class="n">FinishEdgeImageForm</span><span class="p">(),</span>
        <span class="s">&#39;image&#39;</span><span class="p">:</span> <span class="n">image</span><span class="p">,</span>
    <span class="p">})</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Contour 1.0.1 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Hiroyuki Sakai.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>